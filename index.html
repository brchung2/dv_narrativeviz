<!DOCTYPE html>
<html>

<script src="https://d3js.org/d3.v5.min.js"></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>

    <style type="text/css">
     .overlay {
        fill: none;
        pointer-events: all;
    }

    .focus circle {
        fill: #ff0000;
    }

    .focus text {
        font-size: 14px;
    }

    .tooltip {
        width: 175px;
        padding: 4px 10px;
        border: 1px solid #aaa;
        border-radius: 4px;
        box-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        position: absolute;
        background-color: white;
        font-size: 14px;
        pointer-events: none;
        -webkit-transition: all 0.25s;
        -moz-transition: all 0.25s;
        -ms-transition: all 0.25s;
        -o-transition: all 0.25s;
        transition: all 0.25s;
    }

    .tooltip div {
        margin: 3px 0;
    }

    .tooltip-year, .tooltip-wld, .tooltip-usa {
        font-weight: bold;
	}

    .grid line {
	    stroke: lightgrey;
	    stroke-opacity: 0.5;
	    shape-rendering: crispEdges;
	}
	.grid path {
	    stroke-width: 0;
	}
	    
	.area {
	fill: #EDE624;
}
	    
    </style>   
    
<body onload='init()'> 
	
<!-- <div id="tooltip"></div>     -->

<script>
	
// =========================== Load data ===========================	
async function init() {
	const data = await d3.csv('emission3.csv');
    	console.log(data);
	
	plotting(data);
}

// code for plotting chart
function plotting(data) {
	
	// =========================== Chart Dimensions ===========================	
	// set line chart dimensions
	var margin = {top: 30, right: 50, bottom: 50, left: 50}
	, width = 740 - margin.left - margin.right
	, height = 450 - margin.top - margin.bottom;

	// add svg canvas dimensions
	var svg = d3.select("body")
		.append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
		.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");


	// Add graph title
	svg.append("text")
	.attr("x", (width / 2))             
	.attr("y", 0 - (margin.top / 2))
	.attr("text-anchor", "middle")  
	.style("font-size", "16px")  
	.text("Global CO2 Emissions units");

	// =========================== Axes ===========================
	// Create X axis
	var x = d3.scaleLinear()
	.domain([1960, 2017])
	.range([ 0, width]);
	
	// Add X axis to svg
	svg.append("g")
	.attr("transform", "translate( 0," + height + ")")
	.call(d3.axisBottom(x).tickFormat(d3.format("d")));

	// Add label to X axis
	svg.append("text")             
	.attr("transform", "translate(" + (width/2) + " ," + (height + (margin.top)) + ")")
	.attr("dy", "1em")
	.style("text-anchor", "middle")
	.text("Year");

	
	// Create Y axis
	var y = d3.scaleLinear()
	.domain([0, 35])
	.range([ height, 0]);

	// Add Y axis to svg
	svg.append("g")
	.attr("transform", "translate(0, 0)")
	.call(d3.axisLeft(y).tickFormat(d3.format("d")));

	// Add label to y axis
	svg.append("text")
	.attr("transform", "rotate(-90)")
	.attr("x", 0 - (height / 2))
	.attr("y", 0 - margin.left)
	.attr("dy", "1em")
	.style("text-anchor", "middle")
	.text("CO2 Emissions - billion metric tons"); 

	// =========================== Add data lines to graph ===========================


	// WORLD data in red
	svg.append("path")
	.datum(data) 
	.attr("d", d3.line()
	.x(function(d) { return x(d.year); }) 
	.y(function(d) { return y(d.WLD); }))  
	.attr("fill", "none")
	.attr("stroke", "#ff0000") 
	.attr("stroke-width", 3);

	// US data in blue
	svg.append("path")
	.datum(data) 
	.attr("d", d3.line()
	.x(function(d) { return x(d.year); }) 
	.y(function(d) { return y(d.USA); }))  
	.attr("fill", "none")
	.attr("stroke", "#004cff") 
	.attr("stroke-width", 3);

	

	// =========================== Gridlines ===========================
	// X axis gridllines (vertical)
	function make_x_gridlines() {
	    return d3.axisBottom(x)
		.ticks(11)
	}

	// Y axis gridllines (horizontal)
	function make_y_gridlines() {
	    return d3.axisLeft(y)
		.ticks(11)
	}

	// Add the X gridlines
	svg.append("g")
	    .attr("class", "grid")
	    .attr("transform", "translate(0," + height + ")")
	    .call(make_x_gridlines()
		.tickSize(-height)
		.tickFormat("")
	    )

	// Add the Y gridlines
	svg.append("g")
	    .attr("class", "grid")
	    .call(make_y_gridlines()
		.tickSize(-width)
		.tickFormat("")
	    )
	
	// =========================== Annotations/Highlight events on graph ===========================
	
// 	const annotations = [

// 	{
// 	  note: { 
// 	    title: "Recession GDP -5.1%", 
// 	    lineType: "none", 
// 	    align: "middle",
// 	    wrap: 150 //custom text wrapping
// 	  },
// 	  subject: {
// 	    height: height,
// 	    width: x(1973) - x(1976)
// 	  },
// 	  type: d3.annotationCalloutRect,
// 	  y: margin.top,
// 	  disable: ["connector"], // doesn't draw the connector
// 	  //can pass "subject" "note" and "connector" as valid options
// 	  dx: (x(1973) - x(1976))/2,
// 	  data: { x: 1976}
// 	}
// 				]
	
// 	// Add annotation to the chart
// 	const makeAnnotations = d3.annotation()
// 	.annotations(annotations)

// 	svg.append('g')
// 	.attr('class', 'annotation-group')
// 	.call(makeAnnotations)
	
	
	var left = x(1973);
	var right = x(1975);
	var wid = right - left;
	svg.append("rect")
	.attr("x", left)
	.attr("width", wid)
	.attr("height", height)
	.style("opacity", 0.5)
	.style("fill", "#F5FF33");
	
	svg.append("text")
	.attr("x", x(1975) + 4)             
	.attr("y", y(17) - 40)
	.attr("text-anchor", "left")  
	.style("font-size", "14px")
	.text("1973-1975: Oil Crisis");  
	
	var left = x(1979);
	var right = x(1983);
	var wid = right - left;
	svg.append("rect")
	.attr("x", left)
	.attr("width", wid)
	.attr("height", height)
	.style("opacity", 0.5)
	.style("fill", "#F5FF33");
	
	svg.append("text")
	.attr("x", x(1983) + 4)             
	.attr("y", 30)
	.attr("text-anchor", "left")  
	.style("font-size", "14px")
	.text("1979-1983: Oil Crisis 2");  
	
	
	var left = x(1990);
	var right = x(1994);
	var wid = right - left;
	svg.append("rect")
	.attr("x", left)
	.attr("width", wid)
	.attr("height", height)
	.style("opacity", 0.5)
	.style("fill", "#F5FF33");
	
	svg.append("text")
	.attr("x", x(1994) + 4)             
	.attr("y", 30)
	.attr("text-anchor", "left")  
	.style("font-size", "14px")
	.text("1990-1994: Collapse of Soviet Union");  
	
	var left = x(1997);
	var right = x(1999);
	var wid = right - left;
	svg.append("rect")
	.attr("x", left)
	.attr("width", wid)
	.attr("height", height)
	.style("opacity", 0.5)
	.style("fill", "#F5FF33");
	
	svg.append("text")
	.attr("x", x(1999) + 4)             
	.attr("y", 30)
	.attr("text-anchor", "left")  
	.style("font-size", "14px")
	.text("1997-1999: Asian Financial Crisis");  
	
	
	var left = x(2008);
	var right = x(2009);
	var wid = right - left;
	svg.append("rect")
	.attr("x", left)
	.attr("width", wid)
	.attr("height", height)
	.style("opacity", 0.5)
	.style("fill", "#F5FF33");
	
	svg.append("text")
	.attr("x", x(2009) + 4)             
	.attr("y", 30)
	.attr("text-anchor", "left")  
	.style("font-size", "14px")
	.text("2008-2009: Global Financial Crisis & Kyoto Protocol");  
	
	var left = x(2015);
	var right = x(2016);
	var wid = right - left;
	svg.append("rect")
	.attr("x", left)
	.attr("width", wid)
	.attr("height", height)
	.style("opacity", 0.5)
	.style("fill", "#F5FF33");
	
	svg.append("text")
	.attr("x", x(2016) + 4)             
	.attr("y", 30)
	.attr("text-anchor", "left")  
	.style("font-size", "14px")
	.text("2015: Paris Climate Agreement");  
	
	// =========================== Tooltip ===========================
	// source from: https://bl.ocks.org/Qizly/8f6ba236b79d9bb03a80

    	var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("display", "none");
	
	var focus = svg.append("g")
	.attr("class", "focus")
	.style("display", "none");

	focus.append("circle")
	.attr("r", 5);
	
	//== Tooltip content: 
	// Year
	var tooltipyear = tooltip.append("div")
        .attr("class", "tooltip-year");
	
	// Newline- "Global Emissions:"
	var tooltiptext = tooltip.append("div");
	tooltiptext.append("span")
	.text("Global Emissions: ");
	
 	// emission value
	var tooltipvalue = tooltiptext.append("span")
        .attr("class", "tooltip-wld");
	
	// units
	var tooltipunits = tooltiptext.append("span")
        .text(" BMT")
	.attr("class", "tooltip-wld");
	
	// Newline- "USA Emissions:"
	var tooltiptextUSA = tooltip.append("div");
         tooltiptextUSA.append("span")
         .text("USA Emissions: ");
	
	// emission value
         var tooltipusavalue = tooltiptextUSA.append("span")
                .attr("class", "tooltip-usa");      

	// units
	var tooltipunits = tooltiptextUSA.append("span")
        .text(" BMT")
	.attr("class", "tooltip-wld");
	
	
        svg.append("rect")
            .attr("class", "overlay")
            .attr("width", width)
            .attr("height", height)
            .on("mouseover", function() { focus.style("display", null); tooltip.style("display", null);  })
            .on("mouseout", function() { focus.style("display", "none"); tooltip.style("display", "none"); })
            .on("mousemove", mousemove);

	var formatValue = d3.format("d");
	
// 	var winWidth = $(window).width(); 
//                 var winOffset = 0;
                
//                 if(winWidth > 1000){
//                     winOffset = (winWidth - 1000) / 2;  
//                 }

	function mousemove() {
		var x0 = x.invert(d3.mouse(this)[0]);
		bisectYear = d3.bisector(function(a, b){ return a.year - b; }).right;
		var i = bisectYear(data, x0),
		d0 = data[i - 1],
		d1 = data[i],
		d = x0 - d0.year > d1.year - x0 ? d1 : d0;
		focus.attr("transform", "translate(" + x(d.year) + "," + y(d.WLD) + ")");
		tooltip.attr("style", "left:" + (x(d.year) + 65) + "px;top:" + (y(d.WLD)+65) + "px;");
		tooltip.select(".tooltip-year").text(formatValue(d.year));
		tooltip.select(".tooltip-wld").text(d.WLD)
		tooltip.select(".tooltip-usa").text(d.USA);
	}

	
}	  

</script>
</body>
</html> 
 
 
