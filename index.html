<!DOCTYPE html>
<html>

<script src="https://d3js.org/d3.v5.min.js"></script>

    <style type="text/css">
    /* 13. Basic Styling with CSS */


    .overlay {
      fill: none;
      pointer-events: all;
    }

    .dot {
        fill: #ffab00;
        stroke: #fff;
    }

      .focus circle {
      fill: none;
      stroke: steelblue;
    }

</style>   
    
<body onload='init()'> 
    

<script>

async function init() {

// 2. Use the margin convention practice 
var margin = {top: 50, right: 50, bottom: 50, left: 50}
  , width = 740 - margin.left - margin.right
  , height = 450 - margin.top - margin.bottom;

// Add svg
var svg = d3.select("body")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
    "translate(" + margin.left + "," + margin.top + ")");
	
    
const data = await d3.csv('emission3.csv');
    console.log(data);
//     d3.select('body')
//       .selectAll('p')
//       .data(data)
//       .enter()
//       .append('p')
//       .html(function(d,i) {return 'year ' + d.year+ ' = ' + d.emission ;});

// Add chart title
svg.append("text")
.attr("x", (width / 2))             
.attr("y", 0 - (margin.top / 2))
.attr("text-anchor", "middle")  
.style("font-size", "16px")  
.text("Global CO2 Emissions units");

// Add X axis
var x = d3.scaleLinear()
.domain([1960, 2017])
.range([ 0, width ]);

svg.append("g")
.attr("transform", "translate(0," + height + ")")
.call(d3.axisBottom(x).tickFormat(d3.format("d")));

// text label for the x axis
svg.append("text")             
.attr("transform",
"translate(" + (width/2) + " ," + 
	    (height + margin.top) + ")")
.style("text-anchor", "middle")
.text("Year");
	
 // Add Y axis for Emissions
var y = d3.scaleLinear()
.domain([0, 35])
.range([ height, 0]);

// formatValue = d3.format(".2s");
svg.append("g")
.call(d3.axisLeft(y).tickFormat(d3.format("d")));

// Text label for the Emissions y axis
svg.append("text")
.attr("transform", "rotate(-90)")
.attr("y", 0 - margin.left)
.attr("x",0 - (height / 2))
.attr("dy", "1em")
.style("text-anchor", "middle")
.text("CO2 Emissions - billion metric tons"); 

	
                
// var path = svg.append("path")
// .datum(data.filter(function(d) {return d.year <= 1973;}))
// .attr("fill", "none")
// .attr("stroke", "#4CAF50")
// .attr("stroke-width", 2)
// .attr("d", d3.line()
//     .x(function(d) { return x(d.year) })
//     .y(function(d) { return y(d.WLD) })
// )

// // Animate emissions line
// var pathLength = path.node().getTotalLength();

// path.attr("stroke-dasharray", pathLength)
//     .attr("stroke-dashoffset", pathLength)
//     .transition()
//     .duration(3500) 
//     .ease(d3.easeSin) 
//     .attr("stroke-dashoffset", 0);
	

// Add the data lines in line graph:	
// Append path, bind the data, and call the line generator 
// WORLD data in red
svg.append("path")
    .datum(data) 
    .attr("class", "line")
    .attr("d", d3.line()
	    .x(function(d) { return x(d.year); }) 
	    .y(function(d) { return y(d.WLD); }))  
    .attr("fill", "none")
    .attr("stroke", "#ff0000") 
    .attr("stroke-width", 3);

// US data in blue
svg.append("path")
    .datum(data) 
    .attr("class", "line")
    .attr("d", d3.line()
	    .x(function(d) { return x(d.year); }) 
	    .y(function(d) { return y(d.USA); }))  
    .attr("fill", "none")
    .attr("stroke", "#004cff") 
    .attr("stroke-width", 3);

// // Append circle point for each datapoint --> looks too busy. 65 circles on a line...
// svg.selectAll(".dot")
//     .data(data)
//   .enter().append("circle") 
//     .attr("class", "dot") 
//     .attr("cx", function(d) { return x(d.year); })
//     .attr("cy", function(d) { return y(d.WLD); })
//     .attr("r", 5)
//       .on("mouseover", function(a, b, c) { 
//   			console.log(a) 
//         this.attr('class', 'focus')
// 		})
//       .on("mouseout", function() {  })

	// Tool Tip
	var tooltip = d3.select("body").append("div")
	.attr("class", "tooltip")
	.style("display", "none");    

	var focus = svg.append("g")
	.attr("class", "focus")
	.style("display", "none");

	focus.append("circle")
	.attr("r", 5);

	var tooltipDate = tooltip.append("div")
	.attr("class", "tooltip-date");

	// Emissions section    
	var tooltipEmissions = tooltip.append("div");

	tooltipEmissions.append("span")
	.attr("class", "tooltip-title")
	.text("Emissions: ");

	var tooltipEmissionsValue = tooltipEmissions.append("span")
	.attr("class", "tooltip-emissions");
                 


	svg.append("rect")
	.attr("class", "overlay")
	.attr("width", width)
	.attr("height", height)
	.on("mouseover", function() { focus.style("display", null); tooltip.style("display", null);  })
	.on("mouseout", function() { focus.style("display", "none"); tooltip.style("display", "none"); })
	.on("mousemove", mousemove);   	
	
	
    function mousemove() {
	var x0 = x.invert(d3.mouse(this)[0]);
	bisect = d3.bisector(function(a, b){ return a.year - b; }).right;
	var i = bisect(data, x0);
	var d0 = data[i - 1];
	var d1 = data[i];
	var d = x0 - d0.year > d1.year - x0 ? d1 : d0;

	var winWidth = $(window).width(); 
	var winOffset = 0;

	if(winWidth > 1000){
	    winOffset = (winWidth - 1000) / 2;  
	}

// 	if (d.Year <= yearTresh) {
	    focus.attr("transform", "translate(" + x(d.year) + "," + y(d.WLD) + ")");
	    tooltip.attr("style", "left:" + (x(d.year) + winOffset + 64) + "px;top:" + (y(d.WLD) + 90) + "px;");
	    tooltip.select(".tooltip-date").text(d.year);
	    tooltip.select(".tooltip-emissions").text(d.WLD);

// 	}

            } 
	
	
	  
}
</script>
</body>
</html> 
 
